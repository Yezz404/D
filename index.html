<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT 匯出檢視器</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-light: #fff0f5;
      --bg-dark: #1e1e1e;
      --text-light: #333;
      --text-dark: #ddd;
      --bubble-user: #ffe4ec;
      --bubble-assistant: #ffffff;
    }
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      display: flex;
      height: 100vh;
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }
    #sidebar {
      width: 300px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      background-color: #fce4ec;
      padding: 1em;
    }
    #main { flex: 1; display: flex; flex-direction: column; }
    #header {
      display: flex; justify-content: space-between;
      padding: 1em; background-color: #ffd1dc;
    }
    #chat { flex: 1; overflow-y: auto; padding: 1em; display: flex; flex-direction: column; }
    .message {
      margin-bottom: 1em; padding: 0.8em; border-radius: 8px;
      max-width: 80%; word-wrap: break-word;
      display: flex; flex-direction: column;
    }
    .user { background-color: var(--bubble-user); align-self: flex-end; }
    .assistant { background-color: var(--bubble-assistant); align-self: flex-start; }
    .timestamp { font-size: 0.75em; color: gray; margin-bottom: 0.3em; }
    .conversation { cursor: pointer; padding: 0.5em; margin-bottom: 0.3em; background-color: #fff; border-radius: 6px; }
    .conversation:hover { background-color: #ffe4ec; }
    #controls { display: flex; gap: 0.5em; align-items: center; }
    button { padding: 0.5em 0.8em; cursor: pointer; }
    .attachment { max-width: 300px; margin-bottom: 0.5em; border:1px solid #ccc; }
    input[type="file"] { margin-bottom: 0.5em; }
    .stats { font-size: 0.9em; margin-top: 0.5em;}
    #bottom-nav { padding: 0.5em; text-align: center; }
    #bottom-nav button { margin: 0 0.5em; }
    .dark .message.user { background-color: #550011; color: #fff; }
    .dark .message.assistant { background-color: #222; color: #fff; }
    .dark #sidebar { background-color: #2b2b2b; color: #ddd; }
    .dark .conversation { background-color: #333; }
    .dark .conversation:hover { background-color: #444; }
  </style>
</head>
<body>

  <div id="sidebar">
    <input type="file" id="fileInput" webkitdirectory directory multiple />
    <div id="ui-info">請選擇 OpenAI 匯出資料夾</div>
    <div id="conversationList"></div>
    <div class="stats" id="stats"></div>
    <div id="list-controls">
      <button onclick="selectAllList()">全選</button>
      <button onclick="deselectAllList()">反選</button>
      <button onclick="exportSelected()">導出選中對話</button>
    </div>
  </div>

  <div id="main">
    <div id="header">
      <div id="controls">
        <button onclick="exportCurrent()">導出此對話 .txt</button>
        <button onclick="exportAll()">導出所有 .zip</button>
        <button onclick="toggleDarkMode()">🌓 切換主題</button>
      </div>
      <input type="text" id="searchInput" placeholder="搜尋所有對話內容…" oninput="searchMessages()">
    </div>
    <div id="chat"></div>
    <div id="bottom-nav">
      <button onclick="prevConvo()">上一個</button>
      <span id="pageIndicator">0 / 0</span>
      <button onclick="nextConvo()">下一個</button>
      <div id="tokenStats" class="stats"></div>
    </div>
  </div>

<script>
let allFiles = {};
let conversations = [];
let currentIndex = -1;
let selectedList = new Set();

document.getElementById("fileInput").addEventListener("change", async (e) => {
  allFiles = {};
  e.target.files.forEach(file => { allFiles[file.webkitRelativePath] = file; });
  if (!allFiles["conversations.json"]) { alert("缺少 conversations.json"); return; }
  const text = await allFiles["conversations.json"].text();
  conversations = JSON.parse(text);
  renderConversationList();
  document.getElementById("ui-info").textContent = `解析完成，找到 ${conversations.length} 個會話`;
  document.getElementById("stats").textContent = "";
  currentIndex = -1;
  renderChat(-1);
});

function renderConversationList(){
  const list = document.getElementById("conversationList");
  list.innerHTML = "";
  conversations.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "conversation";
    div.innerHTML = `<input type="checkbox" data-index="${i}" onchange="checkboxToggle(event)"> ${c.title||"無標題"}`;
    div.onclick = e => { if (e.target.tagName!=="INPUT") renderChat(i) };
    list.appendChild(div);
  });
  updateTokenStatsDisplay();
}

function checkboxToggle(e){
  const i = Number(e.target.getAttribute("data-index"));
  if (e.target.checked) selectedList.add(i); else selectedList.delete(i);
}

function selectAllList(){ conversations.forEach((_,i)=>selectedList.add(i)); updateListCheckboxes();}
function deselectAllList(){ selectedList.clear(); updateListCheckboxes();}
function updateListCheckboxes(){
  document.querySelectorAll('#conversationList input[type="checkbox"]').forEach(cb=>{
    cb.checked = selectedList.has(Number(cb.dataset.index));
  });
}

function exportSelected(){
  exportSubset(Array.from(selectedList));
}

function renderChat(index){
  currentIndex = index;
  const chat = document.getElementById("chat");
  chat.innerHTML = "";
  if (index<0) { document.getElementById("pageIndicator").textContent = `0 / ${conversations.length}`; return; }
  const convo = conversations[index];
  const msgs = Object.values(convo.mapping||{}).filter(m=>m.message);
  msgs.sort((a,b)=> (a.message.create_time||0)-(b.message.create_time||0));
  let userCount=0, aiCount=0, totalTokens = 0;
  msgs.forEach(m=>{
    const msg = m.message;
    const role=msg.author?.role;
    const parts=msg.content?.parts;
    if (!parts||!parts[0]||(role!=="user"&&role!=="assistant")) return;
    const div = document.createElement("div");
    div.className = "message "+role;
    const ts = document.createElement("div");
    ts.className = "timestamp";
    ts.textContent = formatTime(msg.create_time);
    div.appendChild(ts);
    if (msg.metadata?.attachments){
      msg.metadata.attachments.forEach(att=>{
        const key = `attachments/${att.id}-${att.name}`;
        if (allFiles[key]){
          const img = document.createElement("img");
          img.src = URL.createObjectURL(allFiles[key]);
          img.className="attachment";
          div.appendChild(img);
        }
      });
    }
    const md = document.createElement("div");
    md.innerHTML = marked.parse(parts[0]);
    div.appendChild(md);
    chat.appendChild(div);
    role==="user"?userCount++:aiCount++;
    totalTokens += (parts[0].split(/\s+/).length);
  });
  document.getElementById("pageIndicator").textContent = `${index+1} / ${conversations.length}`;
  document.getElementById("tokenStats").textContent = `用戶訊息：${userCount} 次 · AI 回覆：${aiCount} 次 · 約 ${totalTokens} 字`;
}

function formatTime(ts){
  if (!ts) return "";
  const d=new Date(ts*1000);
  return d.toISOString().replace("T"," ").substring(0,19);
}

function exportCurrent(){
  if (currentIndex<0) return;
  exportSubset([currentIndex]);
}

async function exportAll(){
  exportSubset(conversations.map((_,i)=>i));
}

async function exportSubset(idxs){
  const zip = new JSZip();
  for (const i of idxs){
    const convo = conversations[i];
    const title = sanitize(convo.title||`Conversation-${i}`);
    const msgs = Object.values(convo.mapping||{}).filter(m=>m.message);
    msgs.sort((a,b)=> (a.message.create_time||0)-(b.message.create_time||0));
    let txt=`Title: ${title}\n\n`;
    msgs.forEach(m=>{
      const msg=m.message;
      const role=msg.author?.role;
      const content=msg.content?.parts?.[0];
      if (!content||(role!=="user"&&role!=="assistant")) return;
      txt+=`[${formatTime(msg.create_time)}] ${role.toUpperCase()}:\n${content}\n\n`;
    });
    zip.file(`${title}.txt`, txt);
  }
  const blob=await zip.generateAsync({type:'blob'});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download= idxs.length>1?`chatgpt_selected.zip`:`${sanitize(conversations[idxs[0]].title||"chat")}.txt`;
  link.click();
}

function sanitize(s){ return s.replace(/[\\/:*?"<>|]/g,'-').substring(0,50); }

function toggleDarkMode(){ document.body.classList.toggle("dark"); }

function searchMessages(){
  const q=document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll('#chat .message').forEach(m=>{
    m.style.display = m.textContent.toLowerCase().includes(q) ? "" : "none";
  });
}

function nextConvo(){ if(currentIndex+1<conversations.length) renderChat(currentIndex+1); }
function prevConvo(){ if(currentIndex>0) renderChat(currentIndex-1); }

</script>
</body>
</html>
