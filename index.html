<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天記錄查看器 (已修正)</title>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --light-bg: #FFF8F7;
            --light-sidebar-bg: #FFFFFF;
            --light-primary: #FFD2D2;
            --light-secondary: #ffe4e1;
            --light-text: #5C5C5C;
            --light-text-soft: #888888;
            --light-accent: #FFAAAA;
            --light-border: #F0F0F0;
            --light-shadow: rgba(255, 170, 170, 0.15);
            --light-scroll-thumb: #FFD2D2;
            --light-scroll-track: #FFF8F7;

            --dark-bg: #1e1e1e;
            --dark-sidebar-bg: #252526;
            --dark-primary: #333333;
            --dark-secondary: #444444;
            --dark-text: #E0E0E0;
            --dark-text-soft: #AAAAAA;
            --dark-accent: #FFD2D2;
            --dark-border: #3c3c3c;
            --dark-shadow: rgba(0, 0, 0, 0.2);
            --dark-scroll-thumb: #555;
            --dark-scroll-track: #333;

            --font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: var(--font-family);
            overflow: hidden;
            font-size: 16px;
        }

        body {
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        /* --- Light Mode --- */
        body.light-mode {
            background-color: var(--light-bg);
            color: var(--light-text);
        }
        /* --- Dark Mode --- */
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track {
            border-radius: 10px;
            transition: background-color var(--transition-speed);
        }
        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            border: 3px solid transparent;
            background-clip: content-box;
            transition: background-color var(--transition-speed);
        }
        .light-mode ::-webkit-scrollbar-track { background: var(--light-scroll-track); }
        .light-mode ::-webkit-scrollbar-thumb { background-color: var(--light-scroll-thumb); }
        .dark-mode ::-webkit-scrollbar-track { background: var(--dark-scroll-track); }
        .dark-mode ::-webkit-scrollbar-thumb { background-color: var(--dark-scroll-thumb); }


        /* --- Upload Overlay --- */
        #upload-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--light-bg);
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .dark-mode #upload-overlay { background-color: var(--dark-bg); }
        #upload-overlay.hidden { opacity: 0; visibility: hidden; }

        .upload-box {
            text-align: center;
            padding: 40px;
            border-radius: 20px;
            background-color: var(--light-sidebar-bg);
            box-shadow: 0 10px 30px var(--light-shadow);
            border: 2px dashed var(--light-primary);
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed), border var(--transition-speed);
        }
        .dark-mode .upload-box {
            background-color: var(--dark-sidebar-bg);
            box-shadow: 0 10px 30px var(--dark-shadow);
            border-color: var(--dark-accent);
        }
        .upload-box h1 { font-size: 2em; margin-bottom: 10px; color: var(--light-accent); }
        .dark-mode .upload-box h1 { color: var(--dark-accent); }
        .upload-box p { font-size: 1.1em; color: var(--light-text-soft); margin-bottom: 30px; max-width: 400px; }
        .dark-mode .upload-box p { color: var(--dark-text-soft); }

        #upload-button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(45deg, #ffafbd, #ffc3a0);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 175, 189, 0.6);
        }
        #upload-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 175, 189, 0.8);
        }
        #file-input { display: none; }

        /* --- Main Layout --- */
        .container {
            display: flex;
            height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px;
            flex-shrink: 0;
            background-color: var(--light-sidebar-bg);
            border-right: 1px solid var(--light-border);
            display: flex;
            flex-direction: column;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            padding: 10px;
            box-sizing: border-box;
        }
        .dark-mode .sidebar {
            background-color: var(--dark-sidebar-bg);
            border-right-color: var(--dark-border);
        }
        .sidebar-header { padding: 10px; }
        .sidebar-header h2 { margin: 0 0 10px 0; font-size: 1.2em; }

        .search-box, .sort-box {
            display: flex;
            gap: 10px;
            padding: 0 10px 10px 10px;
            align-items: center;
        }
        .search-box input, .sort-box select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--light-border);
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: all var(--transition-speed);
        }
        .dark-mode .search-box input, .dark-mode .sort-box select {
            background-color: var(--dark-bg);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }
        .search-box input:focus, .sort-box select:focus {
            outline: none;
            border-color: var(--light-accent);
            box-shadow: 0 0 0 2px var(--light-shadow);
        }
        .dark-mode .search-box input:focus, .dark-mode .sort-box select:focus {
            border-color: var(--dark-accent);
            box-shadow: 0 0 0 2px rgba(255, 210, 210, 0.2);
        }

        #conversation-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 5px;
        }
        .conversation-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed);
            border: 1px solid transparent;
        }
        .conversation-item:hover {
            background-color: var(--light-secondary);
        }
        .dark-mode .conversation-item:hover {
            background-color: var(--dark-secondary);
        }
        .conversation-item.active {
            background-color: var(--light-primary);
            border-color: var(--light-accent);
            font-weight: bold;
        }
        .dark-mode .conversation-item.active {
            background-color: var(--dark-accent);
            color: #333;
            border-color: var(--light-accent);
        }
        .conversation-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
            margin-bottom: 4px;
        }
        .conversation-timestamp, .conversation-stats {
            font-size: 0.75em;
            color: var(--light-text-soft);
        }
        .dark-mode .conversation-timestamp, .dark-mode .conversation-stats {
            color: var(--dark-text-soft);
        }
        .dark-mode .conversation-item.active .conversation-timestamp,
        .dark-mode .conversation-item.active .conversation-stats {
            color: #555;
        }
        .search-preview {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 5px;
            background-color: rgba(255, 228, 225, 0.5);
            border-radius: 5px;
            color: #c7254e;
        }
        .dark-mode .search-preview {
            background-color: rgba(85, 85, 85, 0.5);
            color: #ffc0cb;
        }
        .search-preview mark {
            background-color: #ffafbd;
            padding: 1px 2px;
            border-radius: 3px;
        }
        .dark-mode .search-preview mark {
            background-color: #ff7f97;
            color: #000;
        }

        .sidebar-footer { padding: 10px; }
        .batch-actions button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color var(--transition-speed);
        }
        #export-zip-btn {
            background-color: var(--light-accent);
            color: white;
        }
        .dark-mode #export-zip-btn { background-color: var(--dark-accent); color: #333; }
        #export-zip-btn:hover { opacity: 0.9; }

        /* --- Chat Container --- */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #welcome-message {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.5em;
            color: var(--light-text-soft);
        }
        .dark-mode #welcome-message { color: var(--dark-text-soft); }

        #chat-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--light-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            min-height: 38px;
        }
        .dark-mode #chat-header { border-bottom-color: var(--dark-border); }
        #chat-title { font-size: 1.2em; font-weight: bold; }
        .chat-actions button {
            background: none;
            border: 1px solid var(--light-border);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 10px;
            transition: all var(--transition-speed);
        }
        .dark-mode .chat-actions button {
            border-color: var(--dark-border);
            color: var(--dark-text);
        }
        .chat-actions button:hover {
            background-color: var(--light-secondary);
            border-color: var(--light-accent);
        }
        .dark-mode .chat-actions button:hover {
            background-color: var(--dark-secondary);
            border-color: var(--dark-accent);
        }

        #message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 25px;
        }

        .message-bubble {
            display: flex;
            margin-bottom: 20px;
            max-width: 90%;
        }
        .message-bubble.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        .message-bubble.assistant {
            margin-right: auto;
        }
        
        .avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin: 0 12px;
        }
        .user .avatar { background-color: #ffafbd; }
        .assistant .avatar { background-color: #a0c4ff; }

        .message-content {
            padding: 12px 18px;
            border-radius: var(--border-radius);
            position: relative;
        }
        .user .message-content {
            background-color: var(--light-secondary);
        }
        .dark-mode .user .message-content {
            background-color: #503d4f;
        }
        .assistant .message-content {
            background-color: var(--light-sidebar-bg);
            box-shadow: 0 2px 5px var(--light-shadow);
        }
        .dark-mode .assistant .message-content {
            background-color: var(--dark-sidebar-bg);
            box-shadow: 0 2px 5px var(--dark-shadow);
        }

        .message-meta {
            font-size: 0.75em;
            color: var(--light-text-soft);
            margin-bottom: 8px;
        }
        .dark-mode .message-meta { color: var(--dark-text-soft); }
        .user .message-meta { text-align: right; }

        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 3px 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity var(--transition-speed);
            font-size: 0.8em;
        }
        .message-content:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background: rgba(0,0,0,0.3); }

        /* --- Markdown & Code --- */
        .message-text p { margin: 0 0 10px 0; }
        .message-text p:last-child { margin-bottom: 0; }
        .message-text a { color: var(--light-accent); text-decoration: none; }
        .dark-mode .message-text a { color: var(--dark-accent); }
        .message-text a:hover { text-decoration: underline; }
        .message-text ul, .message-text ol { padding-left: 20px; }
        .message-text pre {
            position: relative;
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre;
            word-wrap: normal;
        }
        .message-text pre code {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre;
            word-wrap: normal;
        }
        .copy-code-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4a4f5a;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
            opacity: 0;
            transition: opacity var(--transition-speed);
            font-size: 0.8em;
        }
        .message-text pre:hover .copy-code-btn { opacity: 1; }
        .message-text pre:hover .copy-code-btn:hover { background: #5e6472; }
        .message-text mark {
            background-color: #ffafbd;
            padding: 1px 2px;
            border-radius: 3px;
        }
        .dark-mode .message-text mark {
            background-color: #ff7f97;
            color: #000;
        }
        .attachment-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* --- Chat Footer & Content Search --- */
        #chat-footer {
            padding: 10px 25px;
            border-top: 1px solid var(--light-border);
            background-color: var(--light-sidebar-bg);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dark-mode #chat-footer {
            border-top-color: var(--dark-border);
            background-color: var(--dark-sidebar-bg);
        }
        #content-search-input {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--light-border);
            background-color: var(--light-bg);
            color: var(--light-text);
        }
        .dark-mode #content-search-input {
            background-color: var(--dark-bg);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }
        #content-search-nav { display: flex; align-items: center; gap: 5px; }
        #content-search-nav button {
            background: none; border: none; font-size: 1.2em; cursor: pointer;
            color: var(--light-text-soft);
        }
        .dark-mode #content-search-nav button { color: var(--dark-text-soft); }
        #content-search-nav button:disabled { cursor: not-allowed; opacity: 0.5; }

        /* --- Utility & Floating Buttons --- */
        .theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            cursor: pointer;
            font-size: 1.5em;
            padding: 8px;
            border-radius: 50%;
            background-color: var(--light-sidebar-bg);
            color: var(--light-text);
            box-shadow: 0 2px 10px var(--light-shadow);
            transition: all var(--transition-speed);
        }
        .dark-mode .theme-switcher {
            background-color: var(--dark-sidebar-bg);
            color: var(--dark-text);
            box-shadow: 0 2px 10px var(--dark-shadow);
        }
        .theme-switcher:hover { transform: scale(1.1) rotate(15deg); }
        
        #back-to-top, #back-to-bottom {
            position: fixed;
            right: 25px;
            background-color: var(--light-primary);
            color: white;
            border: none;
            width: 45px; height: 45px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 10px var(--light-shadow);
            transition: opacity 0.3s, transform 0.3s, background-color var(--transition-speed);
            opacity: 0;
            visibility: hidden;
        }
        #back-to-top { bottom: 80px; }
        #back-to-bottom { bottom: 25px; }
        #back-to-top.visible, #back-to-bottom.visible { opacity: 1; visibility: visible; }
        #back-to-top:hover, #back-to-bottom:hover { transform: scale(1.1); }
        .dark-mode #back-to-top, .dark-mode #back-to-bottom {
            background-color: var(--dark-accent);
            color: #333;
            box-shadow: 0 4px 10px var(--dark-shadow);
        }

        /* --- PDF Export Styling --- */
        .pdf-render-container {
            width: 400px; /* iPhone-like width */
            font-family: var(--font-family);
            color: #000;
            background-color: #74B9FF; /* LINE-like background */
            padding: 20px 10px;
            box-sizing: border-box;
        }
        .pdf-message-bubble {
            display: flex;
            margin-bottom: 15px;
            max-width: 85%;
            align-items: flex-end;
        }
        .pdf-message-bubble.user { margin-left: auto; flex-direction: row; }
        .pdf-message-bubble.assistant { margin-right: auto; flex-direction: row-reverse; }
        .pdf-message-content {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        .pdf-message-bubble.user .pdf-message-content { background-color: #FFEC44; } /* LINE yellow */
        .pdf-message-bubble.assistant .pdf-message-content { background-color: #FFFFFF; }
        .pdf-timestamp {
            font-size: 10px;
            color: #777;
            margin: 0 5px;
            flex-shrink: 0;
        }
        .pdf-message-text { font-size: 14px; word-break: break-word; }
        .pdf-message-text pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .pdf-attachment-image { max-width: 100%; border-radius: 8px; margin-bottom: 5px; }


        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 200;
                width: 85%;
                transition: left 0.3s ease-in-out;
                box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            }
            .sidebar.open { left: 0; }
            #menu-toggle {
                display: block;
                position: absolute;
                top: 18px;
                left: 15px;
                font-size: 1.5em;
                z-index: 201; /* Above sidebar */
                color: var(--light-text);
            }
            .dark-mode #menu-toggle { color: var(--dark-text); }
            .container.menu-open .chat-container {
                margin-left: 85%;
            }
            .chat-container { transition: margin-left 0.3s ease-in-out; }
            #chat-header { padding: 15px 15px 15px 50px; }
            .message-bubble { max-width: 95%; }
            #back-to-top, #back-to-bottom { width: 40px; height: 40px; font-size: 1.2em; }
        }
        #menu-toggle { display: none; }
    </style>
</head>
<body class="light-mode">

    <div id="upload-overlay">
        <div class="upload-box">
            <h1>聊天記錄</h1>
            <p>請點擊按鈕，並選擇您從 OpenAI 導出後解壓縮的**整個資料夾**（而非單一檔案）。</p>
            <button id="upload-button"><i class="fas fa-folder-open"></i> 選擇資料夾</button>
            <input type="file" id="file-input" webkitdirectory directory multiple>
        </div>
    </div>

    <div id="menu-toggle"><i class="fas fa-bars"></i></div>

    <div class="container" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="conversation-search-input" placeholder="搜尋對話標題...">
                </div>
                <div class="sort-box">
                    <i class="fas fa-sort-amount-down"></i>
                    <select id="sort-select">
                        <option value="newest">最新</option>
                        <option value="oldest">最舊</option>
                        <option value="title_asc">標題 A-Z</option>
                        <option value="title_desc">標題 Z-A</option>
                    </select>
                </div>
            </div>
            <div id="conversation-list"></div>
            <div class="sidebar-footer">
                <p id="conversation-count" style="text-align: center; font-size: 0.9em; color: var(--light-text-soft);"></p>
                <div class="batch-actions">
                    <button id="export-zip-btn"><i class="fas fa-file-archive"></i> 批次導出為 ZIP (TXT)</button>
                </div>
            </div>
        </aside>

        <main class="chat-container">
            <div id="welcome-message">
                <div>
                    <i class="fas fa-comments" style="font-size: 3em; color: var(--light-primary);"></i>
                    <p>從左側選擇一個對話開始</p>
                </div>
            </div>

            <div id="chat-header" style="display: none;">
                <h2 id="chat-title"></h2>
                <div class="chat-actions">
                    <button id="export-txt-btn" title="導出為 TXT"><i class="fas fa-file-alt"></i> TXT</button>
                    <button id="export-pdf-btn" title="導出為 PDF"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>

            <div id="message-list"></div>

            <div id="chat-footer" style="display: none;">
                <input type="text" id="content-search-input" placeholder="在對話中搜尋關鍵字...">
                <div id="content-search-nav">
                    <span id="content-search-results">0 / 0</span>
                    <button id="content-search-prev" disabled>◀️</button>
                    <button id="content-search-next" disabled>▶️</button>
                </div>
            </div>
        </main>
    </div>

    <div class="theme-switcher" id="theme-switcher" title="切換模式">
        <i class="fas fa-moon"></i>
    </div>
    <button id="back-to-top" title="回到頂部">⬆️</button>
    <button id="back-to-bottom" title="回到最底">⬇️</button>

    <script>
    // --- Polyfill for structuredClone ---
    if (!("structuredClone" in window)) {
        window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State Variables ---
        let allConversations = [];
        let uploadedFiles = {};
        let currentConversation = null;
        let currentTheme = 'light';
        let contentSearchMatches = [];
        let currentMatchIndex = -1;

        // --- DOM Element References ---
        const uploadOverlay = document.getElementById('upload-overlay');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        const container = document.querySelector('.container');
        const sidebar = document.querySelector('.sidebar');
        const conversationList = document.getElementById('conversation-list');
        const conversationSearchInput = document.getElementById('conversation-search-input');
        const sortSelect = document.getElementById('sort-select');
        const conversationCount = document.getElementById('conversation-count');
        const welcomeMessage = document.getElementById('welcome-message');
        const chatHeader = document.getElementById('chat-header');
        const chatTitle = document.getElementById('chat-title');
        const messageList = document.getElementById('message-list');
        const chatFooter = document.getElementById('chat-footer');
        const exportTxtBtn = document.getElementById('export-txt-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportZipBtn = document.getElementById('export-zip-btn');
        const themeSwitcher = document.getElementById('theme-switcher');
        const backToTopBtn = document.getElementById('back-to-top');
        const backToBottomBtn = document.getElementById('back-to-bottom');
        const menuToggle = document.getElementById('menu-toggle');
        const contentSearchInput = document.getElementById('content-search-input');
        const contentSearchResults = document.getElementById('content-search-results');
        const contentSearchPrev = document.getElementById('content-search-prev');
        const contentSearchNext = document.getElementById('content-search-next');
        
        // --- Event Listeners ---
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFolderUpload);
        themeSwitcher.addEventListener('click', toggleTheme);
        conversationSearchInput.addEventListener('input', filterAndRenderSidebar);
        sortSelect.addEventListener('change', filterAndRenderSidebar);
        exportTxtBtn.addEventListener('click', () => exportConversation('txt'));
        exportPdfBtn.addEventListener('click', () => exportConversation('pdf'));
        exportZipBtn.addEventListener('click', exportAllAsZip);
        backToTopBtn.addEventListener('click', () => messageList.scrollTo({ top: 0, behavior: 'smooth' }));
        backToBottomBtn.addEventListener('click', () => messageList.scrollTo({ top: messageList.scrollHeight, behavior: 'smooth' }));
        menuToggle.addEventListener('click', () => {
             sidebar.classList.toggle('open');
             container.classList.toggle('menu-open');
        });
        messageList.addEventListener('scroll', handleScrollButtons);

        contentSearchInput.addEventListener('input', handleContentSearch);
        contentSearchPrev.addEventListener('click', navigateSearch(-1));
        contentSearchNext.addEventListener('click', navigateSearch(1));

        // --- Main Functions ---

        /**
         * Handles the folder upload event. Reads files and finds conversations.json.
         */
        function handleFolderUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const conversationsFile = Array.from(files).find(file => file.name === 'conversations.json');
            
            // **FIX 1: Check if a folder was selected**
            if (!conversationsFile) {
                alert('錯誤：在您選擇的項目中找不到 "conversations.json" 檔案。\n\n請確認您選擇的是**整個資料夾**，而不是單一檔案。');
                return;
            }
            if (!conversationsFile.webkitRelativePath) {
                 alert('錯誤：您似乎只選擇了一個檔案。\n\n為了讀取附件，請務必選擇**整個**從 OpenAI 導出並解壓縮後的資料夾。');
                 return;
            }


            // Store all files for attachment lookup
            uploadedFiles = {};
            for (const file of files) {
                const pathParts = file.webkitRelativePath.split('/');
                const fileName = pathParts[pathParts.length - 1];
                uploadedFiles[fileName] = file;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const conversations = Array.isArray(data) ? data : (data.items || null);
                    if (!conversations) {
                         throw new Error("無效的 JSON 格式：找不到 'items' 陣列或不是一個有效的陣列。");
                    }
                    allConversations = conversations.map(c => ({...c, mapping: c.mapping || {}}));
                    filterAndRenderSidebar();
                    uploadOverlay.classList.add('hidden');
                    container.style.display = 'flex';
                } catch (error) {
                    console.error("解析 JSON 失敗:", error);
                    console.error("解析失敗的檔案內容 (前500字元):", e.target.result.substring(0, 500));
                    alert('讀取或解析 "conversations.json" 失敗，請檢查檔案格式是否正確或損毀。\n\n詳細錯誤訊息已記錄在瀏覽器的開發者控制台中 (按 F12)。');
                }
            };
            reader.readAsText(conversationsFile);
        }

        /**
         * Filters, sorts, and renders the conversation list in the sidebar.
         */
        function filterAndRenderSidebar() {
            const searchTerm = conversationSearchInput.value.toLowerCase();
            const sortBy = sortSelect.value;

            let filtered = structuredClone(allConversations);

            if (searchTerm) {
                filtered = filtered.filter(convo => {
                    const titleMatch = convo.title && convo.title.toLowerCase().includes(searchTerm);
                    if (titleMatch) return true;
                    
                    convo.searchPreview = findFirstMatchInConversation(convo, searchTerm);
                    return !!convo.searchPreview;
                });
            }

            filtered.sort((a, b) => {
                const timeA = a.update_time || 0;
                const timeB = b.update_time || 0;
                const titleA = a.title || '';
                const titleB = b.title || '';

                switch (sortBy) {
                    case 'oldest': return timeA - timeB;
                    case 'title_asc': return titleA.localeCompare(titleB);
                    case 'title_desc': return titleB.localeCompare(titleA);
                    case 'newest':
                    default:
                        return timeB - timeA;
                }
            });

            renderSidebar(filtered);
        }

        /**
         * Finds the first message snippet in a conversation that matches the search term.
         */
        function findFirstMatchInConversation(convo, searchTerm) {
            for (const key in convo.mapping) {
                const node = convo.mapping[key];
                if (node.message && node.message.content && node.message.content.parts) {
                    const text = node.message.content.parts.join('');
                    if (text.toLowerCase().includes(searchTerm)) {
                        const index = text.toLowerCase().indexOf(searchTerm);
                        const start = Math.max(0, index - 20);
                        const end = Math.min(text.length, index + searchTerm.length + 20);
                        let snippet = text.substring(start, end).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        snippet = snippet.replace(new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), (match) => `<mark>${match}</mark>`);
                        return `...${snippet}...`;
                    }
                }
            }
            return null;
        }


        /**
         * Renders the conversation list in the sidebar.
         */
        function renderSidebar(conversations) {
            conversationList.innerHTML = '';
            if (conversations.length === 0) {
                conversationList.innerHTML = '<p style="text-align:center; color: var(--light-text-soft);">無符合結果</p>';
                conversationCount.textContent = '找到 0 個會話';
                return;
            }
            
            conversationCount.textContent = `解析完成，找到 ${conversations.length} 個會話`;

            const fragment = document.createDocumentFragment();
            conversations.forEach(convo => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.id = convo.id;
                
                const stats = calculateStats(convo);

                item.innerHTML = `
                    <div class="conversation-title">${convo.title || '無標題對話'}</div>
                    <div class="conversation-timestamp">${formatTimestamp(convo.update_time)}</div>
                    <div class="conversation-stats">
                        <i class="fas fa-user"></i> ${stats.userMessages} | 
                        <i class="fas fa-robot"></i> ${stats.aiMessages} | 
                        <i class="fas fa-file-word"></i> ${stats.wordCount} 字
                    </div>
                    ${convo.searchPreview ? `<div class="search-preview">${convo.searchPreview}</div>` : ''}
                `;
                item.addEventListener('click', () => {
                    displayConversation(convo.id);
                    document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                        container.classList.remove('menu-open');
                    }
                });
                fragment.appendChild(item);
            });
            conversationList.appendChild(fragment);
        }

        /**
         * Displays a selected conversation in the main chat panel.
         */
        function displayConversation(id) {
            currentConversation = allConversations.find(c => c.id === id);
            if (!currentConversation) return;

            welcomeMessage.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatFooter.style.display = 'flex';
            messageList.innerHTML = '';

            chatTitle.textContent = currentConversation.title || '無標題對話';
            
            const messages = getConversationMessages(currentConversation);

            const fragment = document.createDocumentFragment();
            messages.forEach(msg => {
                const role = msg.author.role;
                if ((role !== 'user' && role !== 'assistant') || !msg.content || !msg.content.parts || msg.content.parts[0] === "") {
                    return;
                }
                fragment.appendChild(createMessageBubble(msg));
            });
            messageList.appendChild(fragment);
            
            hljs.highlightAll();
            
            document.querySelectorAll('.message-text pre').forEach(pre => {
                const code = pre.querySelector('code').innerText;
                const button = document.createElement('button');
                button.className = 'copy-code-btn';
                button.innerHTML = '<i class="fas fa-copy"></i> Copy';
                button.addEventListener('click', () => copyToClipboard(code, button, 'Copied!'));
                pre.appendChild(button);
            });

            messageList.scrollTop = messageList.scrollHeight;
            handleScrollButtons();
            handleContentSearch();
        }

        /**
         * Creates a single message bubble element.
         */
        function createMessageBubble(msg) {
            const role = msg.author.role;
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${role}`;

            const contentParts = msg.content.parts;
            let messageText = '';
            let attachmentsHTML = '';

            if (msg.content.content_type === 'multimodal_text' && contentParts) {
                contentParts.forEach(part => {
                    if (typeof part === 'string') {
                        messageText += part;
                    } else if (part && part.content_type === 'image_asset_pointer') {
                        const fileId = part.asset_pointer.file_id;
                        const file = Object.values(uploadedFiles).find(f => f.name.includes(fileId));
                         if (file) {
                            const url = URL.createObjectURL(file);
                            attachmentsHTML += `<img src="${url}" class="attachment-image" alt="Attachment">`;
                        }
                    }
                });
            } else if (contentParts) {
                 messageText = contentParts.join('');
            }

            const avatarChar = role === 'user' ? 'U' : 'A';
            const renderedMarkdown = marked.parse(messageText);

            bubble.innerHTML = `
                <div class="avatar">${avatarChar}</div>
                <div class="message-content">
                    <div class="message-meta">${formatTimestamp(msg.create_time)}</div>
                    <div class="message-text">
                        ${attachmentsHTML}
                        ${renderedMarkdown}
                    </div>
                    <button class="copy-btn"><i class="fas fa-paste"></i></button>
                </div>
            `;
            
            const copyBtn = bubble.querySelector('.copy-btn');
            copyBtn.addEventListener('click', () => copyToClipboard(messageText, copyBtn, 'Copied!'));

            return bubble;
        }
        
        /**
         * Handles searching within the currently displayed conversation.
         */
        function handleContentSearch() {
            const searchTerm = contentSearchInput.value.toLowerCase();
            contentSearchMatches = [];
            currentMatchIndex = -1;

            messageList.querySelectorAll('mark').forEach(mark => {
                mark.outerHTML = mark.innerHTML;
            });
            
            if (!searchTerm || !currentConversation) {
                updateContentSearchNav();
                return;
            }

            const walker = document.createTreeWalker(messageList, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                if (node.parentElement.tagName === 'SCRIPT' || node.parentElement.tagName === 'STYLE' || node.parentElement.tagName === 'MARK') continue;
                
                const text = node.nodeValue;
                const lowerText = text.toLowerCase();
                let matchIndex = lowerText.indexOf(searchTerm);
                
                if (matchIndex !== -1) {
                    const originalNode = node;
                    let lastIndex = 0;
                    const fragment = document.createDocumentFragment();
                    
                    while (matchIndex !== -1) {
                        fragment.appendChild(document.createTextNode(text.substring(lastIndex, matchIndex)));
                        
                        const match = document.createElement('mark');
                        match.textContent = text.substring(matchIndex, matchIndex + searchTerm.length);
                        fragment.appendChild(match);
                        
                        contentSearchMatches.push(match);
                        
                        lastIndex = matchIndex + searchTerm.length;
                        matchIndex = lowerText.indexOf(searchTerm, lastIndex);
                    }
                    fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                    originalNode.parentNode.replaceChild(fragment, originalNode);
                }
            }

            if (contentSearchMatches.length > 0) {
                currentMatchIndex = 0;
                navigateToCurrentMatch();
            }
            updateContentSearchNav();
        }

        function navigateToCurrentMatch() {
            if (currentMatchIndex === -1) return;
            contentSearchMatches.forEach((el, index) => {
                el.style.backgroundColor = index === currentMatchIndex ? '#ff7f97' : '';
            });
            const currentMatch = contentSearchMatches[currentMatchIndex];
            currentMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function navigateSearch(direction) {
            return () => {
                if (contentSearchMatches.length === 0) return;
                currentMatchIndex += direction;
                if (currentMatchIndex < 0) {
                    currentMatchIndex = contentSearchMatches.length - 1;
                } else if (currentMatchIndex >= contentSearchMatches.length) {
                    currentMatchIndex = 0;
                }
                navigateToCurrentMatch();
                updateContentSearchNav();
            };
        }

        function updateContentSearchNav() {
            if (contentSearchMatches.length > 0) {
                contentSearchResults.textContent = `${currentMatchIndex + 1} / ${contentSearchMatches.length}`;
                contentSearchPrev.disabled = false;
                contentSearchNext.disabled = false;
            } else {
                contentSearchResults.textContent = `0 / 0`;
                contentSearchPrev.disabled = true;
                contentSearchNext.disabled = true;
                if(contentSearchInput.value) contentSearchResults.textContent = "無結果";
            }
        }


        // --- Export Functions ---

        function exportConversation(format) {
            if (!currentConversation) return;
            const title = currentConversation.title || 'Untitled Conversation';

            if (format === 'txt') {
                let content = `Title: ${title}\n`;
                content += `Exported on: ${new Date().toLocaleString()}\n\n`;
                
                const messages = getConversationMessages(currentConversation);
                messages.forEach(msg => {
                    const role = msg.author.role;
                    const timestamp = formatTimestamp(msg.create_time);
                    const text = msg.content.parts ? msg.content.parts.join('') : '';
                    content += `[${timestamp}] ${role.toUpperCase()}:\n${text}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                saveAs(blob, `${sanitizeFilename(title)}.txt`);
            } else if (format === 'pdf') {
                generatePdf(currentConversation);
            }
        }

        async function generatePdf(conversation) {
            const title = conversation.title || 'Untitled Conversation';
            const messages = getConversationMessages(conversation);
            const { jsPDF } = window.jspdf;

            const renderContainer = document.createElement('div');
            renderContainer.className = 'pdf-render-container';
            
            messages.forEach(msg => {
                const role = msg.author.role;
                if ((role !== 'user' && role !== 'assistant') || !msg.content || !msg.content.parts || msg.content.parts[0] === "") {
                    return;
                }
                const bubble = createPdfMessageBubble(msg);
                renderContainer.appendChild(bubble);
            });

            document.body.appendChild(renderContainer);

            try {
                const canvas = await html2canvas(renderContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    onclone: (clonedDoc) => {
                        // **FIX 2: Robust image handling for PDF export**
                        clonedDoc.querySelectorAll('.pdf-attachment-image').forEach((img, index) => {
                            const originalImg = renderContainer.querySelectorAll('.pdf-attachment-image')[index];
                            if (originalImg && originalImg.src) { // Check if original image exists
                                img.src = originalImg.src;
                            }
                        });
                    }
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${sanitizeFilename(title)}.pdf`);

            } catch (error) {
                console.error("PDF generation failed:", error);
                alert("生成 PDF 失敗。可能是由於內容過於複雜或存在無法渲染的元素。請檢查控制台以獲取詳細資訊。");
            } finally {
                document.body.removeChild(renderContainer);
            }
        }

        function createPdfMessageBubble(msg) {
             const role = msg.author.role;
             const bubble = document.createElement('div');
             bubble.className = `pdf-message-bubble ${role}`;

             const contentParts = msg.content.parts;
             let messageText = '';
             let attachmentsHTML = '';

             if (msg.content.content_type === 'multimodal_text' && contentParts) {
                 contentParts.forEach(part => {
                     if (typeof part === 'string') {
                         messageText += part;
                     } else if (part && part.content_type === 'image_asset_pointer') {
                         const fileId = part.asset_pointer.file_id;
                         const file = Object.values(uploadedFiles).find(f => f.name.includes(fileId));
                         if (file) {
                             const url = URL.createObjectURL(file);
                             attachmentsHTML += `<img src="${url}" class="pdf-attachment-image">`;
                         }
                     }
                 });
             } else if (contentParts) {
                 messageText = contentParts.join('');
             }
             
             const renderedMarkdown = marked.parse(messageText).replace(/<p>|<\/p>/g, "");

             bubble.innerHTML = `
                <div class="pdf-message-content">
                    <div class="pdf-message-text">
                        ${attachmentsHTML}
                        ${renderedMarkdown}
                    </div>
                </div>
                <div class="pdf-timestamp">${formatTimestamp(msg.create_time, true)}</div>
             `;
             return bubble;
        }

        function exportAllAsZip() {
            const zip = new JSZip();
            allConversations.forEach(convo => {
                const title = convo.title || 'Untitled Conversation';
                let content = `Title: ${title}\n\n`;
                const messages = getConversationMessages(convo);
                messages.forEach(msg => {
                    const role = msg.author.role;
                    const timestamp = formatTimestamp(msg.create_time);
                    const text = msg.content.parts ? msg.content.parts.join('') : '';
                    content += `[${timestamp}] ${role.toUpperCase()}:\n${text}\n\n`;
                });
                zip.file(`${sanitizeFilename(title)}.txt`, content);
            });

            zip.generateAsync({ type: 'blob' }).then(blob => {
                saveAs(blob, 'ChatGPT_Export_TXTs.zip');
            });
        }


        // --- Helper & Utility Functions ---

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            themeSwitcher.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        function formatTimestamp(unixTime, timeOnly = false) {
            if (!unixTime) return 'N/A';
            const date = new Date(unixTime * 1000);
            if (isNaN(date.getTime())) return 'Invalid Date';
            const Y = date.getFullYear();
            const M = String(date.getMonth() + 1).padStart(2, '0');
            const D = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            const s = String(date.getSeconds()).padStart(2, '0');
            return timeOnly ? `${h}:${m}` : `${Y}-${M}-${D} ${h}:${m}:${s}`;
        }
        
        function calculateStats(convo) {
            let wordCount = 0;
            let userMessages = 0;
            let aiMessages = 0;
            const messages = getConversationMessages(convo);
            messages.forEach(msg => {
                const role = msg.author.role;
                if (msg.content && msg.content.parts) {
                    const text = msg.content.parts.join('');
                    if (role === 'user') userMessages++;
                    if (role === 'assistant') aiMessages++;
                    wordCount += text.split(/\s+/).filter(Boolean).length;
                }
            });
            return { wordCount, userMessages, aiMessages };
        }

        function getConversationMessages(conversation) {
            const messages = [];
            if (!conversation.current_node || !conversation.mapping) return [];
            
            let currentNode = conversation.mapping[conversation.current_node];
            while (currentNode) {
                if (currentNode.message) {
                    messages.push(currentNode.message);
                }
                currentNode = currentNode.parent ? conversation.mapping[currentNode.parent] : null;
            }
            return messages.reverse();
        }

        function copyToClipboard(text, button, successText = 'Copied!') {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = successText;
                button.disabled = true;
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1500);
            }).catch(err => {
                console.error('無法複製:', err);
                alert('複製失敗！');
            });
        }

        function sanitizeFilename(name) {
            return name.replace(/[<>:"/\\|?*]/g, '_').substring(0, 100);
        }

        function handleScrollButtons() {
            if (messageList.scrollHeight > messageList.clientHeight) {
                if (messageList.scrollTop > 200) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
                if (messageList.scrollTop + messageList.clientHeight < messageList.scrollHeight - 200) {
                    backToBottomBtn.classList.add('visible');
                } else {
                    backToBottomBtn.classList.remove('visible');
                }
            } else {
                backToTopBtn.classList.remove('visible');
                backToBottomBtn.classList.remove('visible');
            }
        }
    });
    </script>
</body>
</html>