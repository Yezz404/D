<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT Export Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-light: #fff0f5;
      --bg-dark: #1e1e1e;
      --text-light: #333;
      --text-dark: #ddd;
      --bubble-user: #ffe4ec;
      --bubble-assistant: #ffffff;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      height: 100vh;
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s;
    }

    .dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    #sidebar {
      width: 250px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      background-color: #fce4ec;
      padding: 1em;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #header {
      display: flex;
      justify-content: space-between;
      padding: 1em;
      background-color: #ffd1dc;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
    }

    .message {
      margin-bottom: 1em;
      padding: 0.8em;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .user {
      background-color: var(--bubble-user);
      align-self: flex-end;
    }

    .assistant {
      background-color: var(--bubble-assistant);
      align-self: flex-start;
    }

    .timestamp {
      font-size: 0.75em;
      color: gray;
    }

    .conversation {
      cursor: pointer;
      padding: 0.5em;
      margin-bottom: 0.5em;
      background-color: #fff;
      border-radius: 6px;
    }

    .conversation:hover {
      background-color: #ffe4ec;
    }

    #controls {
      display: flex;
      gap: 1em;
    }

    button {
      padding: 0.5em 1em;
    }

    .attachment {
      max-width: 300px;
      margin-bottom: 0.5em;
    }

    .dark .message.user { background-color: #550011; color: white; }
    .dark .message.assistant { background-color: #222; color: white; }
    .dark #sidebar { background-color: #2b2b2b; color: white; }
    .dark .conversation { background-color: #333; }
    .dark .conversation:hover { background-color: #444; }
  </style>
</head>
<body>

  <div id="sidebar">
    <input type="file" id="fileInput" webkitdirectory directory multiple />
    <div id="conversationList"></div>
  </div>

  <div id="main">
    <div id="header">
      <div id="controls">
        <button onclick="exportCurrent()">Export This .txt</button>
        <button onclick="exportAll()">Export All .zip</button>
        <button onclick="toggleDarkMode()">ðŸŒ“ Mode</button>
      </div>
      <input type="text" id="searchInput" placeholder="Search..." oninput="searchMessages()">
    </div>
    <div id="chat"></div>
  </div>

  <script>
    let allFiles = {};
    let conversations = [];
    let currentIndex = -1;

    document.getElementById("fileInput").addEventListener("change", async (e) => {
      allFiles = {};
      for (const file of e.target.files) {
        allFiles[file.webkitRelativePath] = file;
      }

      if (!allFiles["conversations.json"]) {
        alert("Missing conversations.json");
        return;
      }

      const text = await allFiles["conversations.json"].text();
      conversations = JSON.parse(text);
      renderConversationList();
    });

    function renderConversationList() {
      const list = document.getElementById("conversationList");
      list.innerHTML = "";
      conversations.forEach((c, i) => {
        const div = document.createElement("div");
        div.className = "conversation";
        div.textContent = c.title || "Untitled";
        div.onclick = () => renderChat(i);
        list.appendChild(div);
      });
    }

    function renderChat(index) {
      currentIndex = index;
      const convo = conversations[index];
      const chat = document.getElementById("chat");
      chat.innerHTML = "";

      const mapping = Object.values(convo.mapping || {}).filter(m => m.message);
      mapping.sort((a, b) => (a.message.create_time || 0) - (b.message.create_time || 0));

      mapping.forEach(m => {
        const msg = m.message;
        const role = msg.author?.role;
        const content = msg.content?.parts?.[0];
        if (!content || (role !== "user" && role !== "assistant")) return;

        const container = document.createElement("div");
        container.className = "message " + role;

        const timestamp = document.createElement("div");
        timestamp.className = "timestamp";
        timestamp.textContent = formatTimestamp(msg.create_time);
        container.appendChild(timestamp);

        // Attachments
        if (msg.metadata?.attachments) {
          for (const att of msg.metadata.attachments) {
            const fileKey = `attachments/${att.id}-${att.name}`;
            if (allFiles[fileKey]) {
              const img = document.createElement("img");
              img.src = URL.createObjectURL(allFiles[fileKey]);
              img.className = "attachment";
              container.appendChild(img);
            }
          }
        }

        const html = marked.parse(content);
        const div = document.createElement("div");
        div.innerHTML = html;
        container.appendChild(div);
        chat.appendChild(container);
      });

      chat.scrollTop = 0;
    }

    function formatTimestamp(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      return d.toISOString().replace("T", " ").substring(0, 19);
    }

    function exportCurrent() {
      if (currentIndex === -1) return;
      const convo = conversations[currentIndex];
      const title = sanitize(convo.title || "Untitled");
      const mapping = Object.values(convo.mapping || {}).filter(m => m.message);
      mapping.sort((a, b) => (a.message.create_time || 0) - (b.message.create_time || 0));

      let txt = `Title: ${title}\n\n`;
      mapping.forEach(m => {
        const msg = m.message;
        const role = msg.author?.role;
        const content = msg.content?.parts?.[0];
        if (!content || (role !== "user" && role !== "assistant")) return;
        txt += `[${formatTimestamp(msg.create_time)}] ${role.toUpperCase()}:\n${content}\n\n`;
      });

      const blob = new Blob([txt], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${title}.txt`;
      link.click();
    }

    async function exportAll() {
      const zip = new JSZip();
      for (let i = 0; i < conversations.length; i++) {
        const convo = conversations[i];
        const title = sanitize(convo.title || "Untitled");
        const mapping = Object.values(convo.mapping || {}).filter(m => m.message);
        mapping.sort((a, b) => (a.message.create_time || 0) - (b.message.create_time || 0));

        let txt = `Title: ${title}\n\n`;
        mapping.forEach(m => {
          const msg = m.message;
          const role = msg.author?.role;
          const content = msg.content?.parts?.[0];
          if (!content || (role !== "user" && role !== "assistant")) return;
          txt += `[${formatTimestamp(msg.create_time)}] ${role.toUpperCase()}:\n${content}\n\n`;
        });

        zip.file(`${title}.txt`, txt);
      }

      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `chatgpt_dialogues.zip`;
      link.click();
    }

    function sanitize(name) {
      return name.replace(/[\\/:*?"<>|]/g, "-").substring(0, 50);
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    function searchMessages() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      if (currentIndex === -1) return;
      const chat = document.getElementById("chat");
      const messages = chat.querySelectorAll(".message");
      messages.forEach(m => {
        const text = m.textContent.toLowerCase();
        m.style.display = text.includes(q) ? "" : "none";
      });
    }
  </script>
</body>
</html>